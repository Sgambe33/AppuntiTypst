name: Compile Typst Documents
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */2 * *"
jobs:
  compile-typst:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Check for new commits on main since last run
      id: check-commits
      run: |
        BRANCH="main"
        # Ensure we have the latest refs for the branch we care about
        git fetch origin $BRANCH || true
        # Find last successful run (if any)
        last_run=$(gh run list --workflow "Compile Typst Documents" --json createdAt,status,conclusion \
          --jq '[.[] | select(.status=="completed" and .conclusion=="success")][0].createdAt' || echo "")
        if [ -z "$last_run" ]; then
          echo "No previous successful run found. Proceeding..."
          echo "new_commits=true" >> $GITHUB_OUTPUT
        else
          echo "Last successful run was at: $last_run"
          # Check for new commits on the main branch since last run
          if git log origin/"$BRANCH" --since="$last_run" --oneline | grep .; then
            echo "New commits found on branch $BRANCH."
            echo "new_commits=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits on branch $BRANCH since last run. Skipping build."
            echo "new_commits=false" >> $GITHUB_OUTPUT
          fi
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Install Typst
      if: steps.check-commits.outputs.new_commits == 'true'
      run: |
        wget https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz
        tar -xf typst-x86_64-unknown-linux-musl.tar.xz
        sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
        typst --version
    - name: Find and compile Typst documents
      if: steps.check-commits.outputs.new_commits == 'true'
      run: |
        mkdir -p compiled-pdfs
        find . -name "main.typ" -type f | while read -r file; do
          echo "Processing: $file"
          dir_path=$(dirname "$file" | sed 's|^\./||')
          pdf_name=$(echo "$dir_path" | sed 's|/|_|g' | sed 's| |_|g')
          [ -z "$pdf_name" ] || [ "$pdf_name" = "." ] && pdf_name="main"
          typst compile --root . "$file" "compiled-pdfs/${pdf_name}.pdf"
        done
    - name: List compiled PDFs
      if: steps.check-commits.outputs.new_commits == 'true'
      run: ls -la compiled-pdfs/
    - name: Publish build artifacts
      if: steps.check-commits.outputs.new_commits == 'true'
      uses: marvinpinto/action-automatic-releases@latest
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        automatic_release_tag: latest
        title: latest
        prerelease: false
        files: |
          compiled-pdfs/*.pdf
